
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Stalls: Publicly readable, but only writable by the admin.
    match /stalls/{stallId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.email == 'admin@u-dry.com';
    }

    // Users:
    // - The admin can read and write any user document.
    // - A user can read and update their OWN document.
    match /users/{userId} {
      allow read, update: if request.auth != null && (request.auth.uid == userId || request.auth.token.email == 'admin@u-dry.com');
      allow create: if request.auth != null; // Allow any authenticated user to create their own user document
      allow list: if request.auth != null && request.auth.token.email == 'admin@u-dry.com';
    }

    // Rentals: Only accessible by the admin for reporting and management.
    match /rentals/{rentalId} {
      allow read, list, write: if request.auth != null && request.auth.token.email == 'admin@u-dry.com';
    }

    // Processed Stripe Payments: Can only be created by authenticated users (via backend function)
    // and read only by the admin for auditing.
    match /processed_stripe_payments/{sessionId} {
      allow read: if request.auth != null && request.auth.token.email == 'admin@u-dry.com';
      // Write access should only be from a trusted backend (Cloud Function), so no client write access is needed.
      allow write: if false;
    }
  }
}
