rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // --- Collection Rules ---

    // Admins collection is readable by any logged-in user to verify admin status.
    match /admins/{adminId} {
      allow read: if request.auth != null;
    }

    // Settings collection is readable by any logged-in user for things like announcements.
    match /settings/{docId} {
      allow read: if request.auth != null;
    }

    // Stalls can be read/updated by any user (for rental transactions), but only created/deleted by admins.
    match /stalls/{stallId} {
      allow read, update: if request.auth != null;
      allow create, delete: if isAdmin();
    }

    // Users can read/write their own data. Admins can read/write ANY user data.
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow write: if request.auth.uid == userId || isAdmin();
    }

    // Rental history can only be read by the user who owns them or an admin. No one can write/delete history.
    match /rentals/{rentalId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow write, delete: if false;
    }
  }
}
