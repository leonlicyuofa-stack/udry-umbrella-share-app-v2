rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a user is an admin
    function isAdmin() {
      // Check against the user's email for simplicity and security
      return request.auth.token.email == 'admin@u-dry.com' &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Users can read and write ONLY to their own document.
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // Admins collection for role-based access control. Only admins can read the list.
    match /admins/{adminId} {
      allow read: if isAdmin();
    }

    // Stalls can be read by any authenticated user.
    // Stalls can be UPDATED by any auth user (for decrementing umbrella count during rental).
    // Stalls can only be CREATED or DELETED by a verified admin.
    match /stalls/{stallId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null;
      allow create, delete: if isAdmin();
    }
    
    // Rentals can be created by any authenticated user.
    // Past rentals can only be read by the user who made them or an admin.
    match /rentals/{rentalId} {
        allow create: if request.auth != null;
        allow read: if (request.auth != null && resource.data.userId == request.auth.uid) || isAdmin();
    }
    
    // Processed stripe payments are internal records and should not be client-readable.
    match /processed_stripe_payments/{paymentId} {
        allow read, write: if false;
    }
    
    // Refund records are internal and should not be client-readable.
     match /refunds/{refundId} {
        allow read, write: if false;
    }
    
    // Global settings can be read by anyone to get announcements.
    // Only admins can write to global settings.
    match /settings/global {
        allow read;
        allow write: if isAdmin();
    }
  }
}
